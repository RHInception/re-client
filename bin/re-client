#!/usr/bin/env python
# -*- coding: utf-8 -*-
# Copyright Â© 2014 SEE AUTHORS FILE
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

import readline
from reclient import ReClient
import os
import argparse
import atexit

conf_file = os.path.expanduser('~/.rerest.conf')
readline.parse_and_bind("tab: complete")
try:
    histfile = os.path.expanduser('~/.reclienthist')
    readline.read_history_file(histfile)
except IOError:
    pass


def cmds():
    print """
0) Get all playbooks ever
1) Get all playbooks for a project
2) Get a single playbook for a project
3) Update a playbook
4) Delete a playbook
5) Create a new playbook
6) Quit"""

def repl(args):
    with open(conf_file, 'r') as config:
        baseurl = config.read()

    reclient = ReClient(baseurl)
    while True:
        cmds()
        try:
            action = int(raw_input("command>> "))
        except KeyboardInterrupt, ke:
            raise ke
        except:
            continue

        if action == 0:
            # ALL PLAYBOOKS
            reclient.get_all_playbooks_ever()
        elif action == 1:
            # ALL PLAYBOOKS FOR A PROJECT
            if args.project is None:
                project = raw_input("Project: ")
            else:
                project = args.project
            reclient.get_all_playbooks(project)
        elif action == 2:
            # GET A SINGLE PLAYBOOK FOR A PROJECT
            if args.project is None:
                project = raw_input("Project: ")
            else:
                project = args.project
            if args.id is None:
                pb_id = raw_input("Playbook ID: ")
            else:
                pb_id = args.id
            reclient.view_file(project, pb_id)
        elif action == 3:
            # UPDATE A PLAYBOOK
            if args.project is None:
                project = raw_input("Project: ")
            else:
                project = args.project
            if args.id is None:
                pb_id = raw_input("Playbook ID: ")
            else:
                pb_id = args.id
            reclient.edit_playbook(project, pb_id)
        elif action == 4:
            # DELETE A PLAYBOOK
            if args.project is None:
                project = raw_input("Project: ")
            else:
                project = args.project
            if args.id is None:
                pb_id = raw_input("Playbook ID: ")
            else:
                pb_id = args.id
            reclient.delete_playbook(project, pb_id)
        elif action == 5:
            # CREATE A NEW PLAYBOOK
            if args.project is None:
                project = raw_input("Project: ")
            else:
                project = args.project
            reclient.new_playbook(project)
        elif action == 6:
            # Quit
            raise SystemExit

if __name__ == '__main__':
    if not os.path.exists(conf_file):
        print "Could not load base rerest url from %s" % conf_file
        print "Enter the base url (http://.......:PORT) for your rerest endpoint"
        print "This will be saved in %s for reuse later" % conf_file
        baseurl = raw_input("Base Url: ")

        with open(conf_file, 'w') as _config:
            _config.write(baseurl)

    parser = argparse.ArgumentParser(description='Release Engine Client Utility')
    parser.add_argument('-p', '--project', required=False,
                        default=None, help='Set default project')
    parser.add_argument('-i', '--id', required=False,
                        default=None, help='Set default playbook ID')
    args = parser.parse_args()

    atexit.register(readline.write_history_file, histfile)

    repl(args)
